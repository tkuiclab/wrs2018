<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="author" content="NEET">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta id="apple-mobile-web-app-capable" name="apple-mobile-web-app-capable" content="yes" >
  <title>TIMDA Assistant</title>
  <link rel="stylesheet" href="css/index.css">
  <link rel="stylesheet" href="css/fontawesome/css/all.min.css">
  <link rel="stylesheet" href="css/signal.css">
  <link rel="stylesheet" href="css/shopping.css">
</head>
<body>
  <h1>Hello, TIMDA Assistant &nbsp;&nbsp;<i class="fas fa-shopping-cart" id="myBtn"></i></h1>
  <!-- The Shopping Modal -->
  <div id="myModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Welcome</h2>
      <hr>
      <p>Would you like to try some......</p>
      <input type="checkbox"/><img src="img/sandwich.jpeg">
      <input type="checkbox"/><img src="img/cola.jpg">
      <input type="checkbox"/><img src="img/box.png">
      <input type="checkbox"/><img src="img/milktea.jpg"><br>
      <input type="checkbox"/><img src="img/blacktea.jpg">
      <input type="checkbox"/><img src="img/slippers.jpg">
      <input type="button" value="Send" id="sendOrder" onclick="SendOrder()"/>
    </div>
  </div>

  <div class = "full-view">
    <p>Make sure you are using a recent version of Google Chrome.</p>
    <p>Also before you enable microphone input either plug in headphones or turn the volume down if you want to avoid ear splitting feedback!</p>
  </div>

  <audio id = "output" class = "full-view" autoplay preload controls></audio>
  <div class = "centered">
    <button id = "recordBtn" class = "btn" type="button" value="Record" onclick="Recording(this)">Record</button>
  </div>
  
  <div class = "full-view">
    <h2>Recordings</h2>
    <ul id="recordingslist"></ul>
    <h2>Log</h2>
    <pre id="log"></pre>
  </div>
  <h1 class = "full-view">Signal</h1>
  <div class = "full-view" id="d"></div>

<script src="js/eventemitter2.min.js"></script>
<script src="js/roslib.min.js"></script>
<script src="../dist/recorder.js"></script>
<script src="js/beep.js"></script>
<script src="js/socket.io.js"></script>
<script src="js/websocket.js"></script>
<script src="js/shopping.js"></script>
<script src="js/jquery.min.js"></script>
<script>
window.onload = function(){

  window.AudioContext = window.AudioContext || window.webkitAudioContext;
  navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
  window.URL = window.URL || window.webkitURL;
  var recorder;

  var d = document.getElementById('d');
  for(var i=0; i<256; i++){
    d.innerHTML += '<div></div>';
  }
  var dd = document.querySelectorAll('#d div');

  var timer;
  var context = new AudioContext();

  navigator.getUserMedia({audio: true}, function(stream) {
    var microphone = context.createMediaStreamSource(stream);
    var analyser = context.createAnalyser();
    microphone.connect(analyser);
    //analyser.connect(context.destination);
    analyser.fftSize = 2048;
    var bufferLength = analyser.frequencyBinCount;
    var dataArray = new Uint8Array(analyser.fftSize);
    analyser.getByteFrequencyData(dataArray);

    /* Record Button Status Switch */
    var btn = document.getElementById('recordBtn');
    btn.onclick = function Recording(e) {
      if (btn.value=="Record") {
        btn.value = "";
        document.getElementById('recordBtn').className = "recording";
        document.getElementById('recordBtn').innerHTML = "";
        var spin = document.createElement('i')
        spin.className = "fas fa-spinner fa-spin fa-2x";
        document.getElementById('recordBtn').appendChild(spin);
        /* Start Recording */
        recorder = new Recorder(microphone);
        recorder.record();
        update();
      }else {
        btn.value = "Record";
        document.getElementById('recordBtn').className = "btn";
        document.getElementById('recordBtn').innerHTML = "Record";
        /* Stop Recording */
        clearTimeout(timer);
        recorder.stop();
        getStereoAudio()
        createDownloadLink();
        recorder.clear();
      }
    }
    // var output = document.getElementById('output');

    // function __log(e, data) {
    //   log.innerHTML += "\n" + e + " " + (data || '');
    // }

    function update(){
      // console.log(dataArray);
      analyser.getByteFrequencyData(dataArray);
      for(var j=0; j<256; j++){
        dd[j].style.height = dataArray[j]+'px';
        dd[j].style.background = 'rgba('+(255-j)+','+j*2+',0,1)';
      }
      timer = setTimeout(update,20);
    }

    function getStereoAudio() {
      recorder && recorder.exportData(function(data) {
        console.log(data);
        ws.send(data);
      });
    }

    function createDownloadLink(){
      recorder.exportWAV(function(blob) {
        var url = URL.createObjectURL(blob);
        var li = document.createElement('li');
        var au = document.createElement('audio');
        var hf = document.createElement('a');
        
        au.controls = true;
        au.src = url;
        hf.href = url;
        hf.download = new Date().toISOString() + '.wav';
        hf.innerHTML = hf.download;
        li.appendChild(au);
        li.appendChild(hf);
        recordingslist.appendChild(li);
      });
    }
  }, function(){
    console.log('error');
  });
};
</script>
</body>
</html>